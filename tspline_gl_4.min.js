var w_arr,points,parchanged,pointsize_arr,mouseymin,mousexmax,on_point,degree,s_tmesh,t_tmesh,knot_vecs,sfContainer,knotTContainer,knotTst,knotSContainer,knotSst,t_step,s_step,t_min,t_max,s_min,s_max,points_st,t_points_dy,s_points_dy,t_vec,s_vec,abs_s,abs_t,tcrawl,scp_arr,cam,zunit,FELB,knotFelb,puff_arr,sugar,szog1,szog2,drawcn,drawcp,drawkp,drawdm,notPopup,entered_pop,dmx,dmy,shift_x,shift_y,shift_z,no_tmesh,numpoints=34,coffh=.9*(document.getElementById("cvas").offsetHeight-4);function nurbs_weight(t,e,s){for(var n=[0,0,0,0],o=e;o>=0;--o)if(t>=s[o]){if(s[o]==s[o+1])return 0;n[o]=1;break}var i=1;for(o=e;o>=1;--o){for(var _=0;_<o;++_)0!=n[_]&&(n[_]=(t-s[_])/(s[_+i]-s[_])*n[_]),0!=n[_+1]&&(n[_]+=(s[_+i+1]-t)/(s[_+i+1]-s[_+1])*n[_+1]);++i}return n[0]}function init_tmesh(){t_tmesh=[[0,1,2,3,4,5,6,7,8,9,10],[0,1,2,3,4,5,6,7,8,9,10],[0,1,2,3,4,5,6,8,9,10],[0,1,2,3,9,10],[0,1,3,4,9,10],[0,1,5,6,8,9,10],[0,1,2,3,4,5,9,10],[0,1,2,3,5,7,8,9,10],[0,1,3,5,9,10],[0,1,2,3,5,7,8,9,10],[0,1,2,3,5,7,8,9,10],[0,1,2,3,4,5,6,7,8,9,10],[0,1,2,3,4,5,6,7,8,9,10]],s_tmesh=[[0,1,2,3,4,5,6,7,8,9,10,11,12],[0,1,2,3,4,5,6,7,8,9,10,11,12],[0,1,2,3,6,7,9,10,11,12],[0,1,2,3,4,6,7,8,9,10,11,12],[0,1,2,4,6,11,12],[0,1,2,5,6,7,8,9,10,11,12],[0,1,2,5,11,12],[0,1,7,9,10,11,12],[0,1,2,5,7,9,10,11,12],[0,1,2,3,4,5,6,7,8,9,10,11,12],[0,1,2,3,4,5,6,7,8,9,10,11,12]],abs_s=[1,1,2,3,3.5,4,5,6,7,8,9,10,10],abs_t=[1,1,2,4,5,6,7,8,9,10,10],s_points_dy=[[!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0],[!0,!1],[!0,!0,!0],[!0,!0,!0,!0,!0]],t_points_dy=[[!0,!0,!0,!0,!0,!0],[!0,!1],[!0,!1],[!0,!0,!0],[!0,!0,!0,!1],[!0,!0,!0,!0,!0],[!0,!1],[!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0]],knot_vecs=new Array(abs_t.length-4);for(let t=2;t<s_tmesh.length-2;++t){let e=t-2;knot_vecs[e]=new Array(10*(s_tmesh[t].length-4));for(let s=2;s<s_tmesh[t].length-2;++s){let n=s-2;knot_vecs[e][10*n+2]=abs_s[s_tmesh[t][s]];let o=0;for(let i=s_tmesh[t][s]-1;i>=0;--i){for(let s=2;s<t_tmesh[i].length-2;++s){if(abs_t[t_tmesh[i][s]]==abs_t[t]){++o,knot_vecs[e][10*n+2-o]=abs_s[i];break}if(abs_t[t_tmesh[i][s]]>abs_t[t]){s>2&&t_points_dy[i-2][s-3]&&(++o,knot_vecs[e][10*n+2-o]=abs_s[i]);break}}if(2==o)break}o=0;for(let i=s_tmesh[t][s]+1;i<abs_s.length;++i){for(let s=2;s<t_tmesh[i].length-2;++s){if(abs_t[t_tmesh[i][s]]==abs_t[t]){++o,knot_vecs[e][10*n+2+o]=abs_s[i];break}if(abs_t[t_tmesh[i][s]]>abs_t[t]){s>2&&t_points_dy[i-2][s-3]&&(++o,knot_vecs[e][10*n+2+o]=abs_s[i]);break}}if(2==o)break}knot_vecs[e][10*n+7]=abs_t[t],o=0;for(let i=t-1;i>=0;--i){for(let _=2;_<s_tmesh[i].length-2;++_){if(abs_s[s_tmesh[i][_]]==abs_s[s_tmesh[t][s]]){++o,knot_vecs[e][10*n+7-o]=abs_t[i];break}if(abs_s[s_tmesh[i][_]]>abs_s[s_tmesh[t][s]]){_>2&&s_points_dy[i-2][_-3]&&(++o,knot_vecs[e][10*n+7-o]=abs_t[i]);break}}if(2==o)break}o=0;for(let i=t+1;i<abs_t.length;++i){for(let _=2;_<s_tmesh[i].length-2;++_){if(abs_s[s_tmesh[i][_]]==abs_s[s_tmesh[t][s]]){++o,knot_vecs[e][10*n+7+o]=abs_t[i];break}if(abs_s[s_tmesh[i][_]]>abs_s[s_tmesh[t][s]]){_>2&&s_points_dy[i-2][_-3]&&(++o,knot_vecs[e][10*n+7+o]=abs_t[i]);break}}if(2==o)break}}}let t=new Array(s_points_dy.length);t[0]=0;for(let e=0;e<s_points_dy.length-1;++e)t[e+1]=s_points_dy[e].length+t[e];tcrawl=new Array(t_points_dy.length);for(let e=0;e<t_points_dy.length;++e){tcrawl[e]=new Array(t_points_dy[e].length);for(let s=0;s<t_points_dy[e].length;++s)tcrawl[e][s]=t[t_tmesh[e+2][s+2]-2]+s_tmesh[t_tmesh[e+2][s+2]].indexOf(e+2)-2}}function setup(){setAttributes("antialias",!0),degree=3,numpoints=34,w_arr=new Array(numpoints).fill(1),pointsize_arr=new Array(numpoints).fill(1),s_min=abs_s[2],s_max=abs_s[abs_s.length-3],t_min=abs_t[2],t_max=abs_t[abs_t.length-3],knotFelb=15,s_step=(s_max-s_min)/(FELB=33),t_step=(t_max-t_min)/FELB,t_vec=new Array(FELB+1),s_vec=new Array(FELB+1);for(let t=0;t<=FELB;++t)t_vec[t]=t_min+t*t_step,s_vec[t]=s_min+t*s_step;puff_arr=new Array(3*(FELB+1));var t=document.getElementById("cvas");createCanvas(t.offsetWidth,t.offsetHeight-4,WEBGL).parent("cvas"),cam=createCamera(),addScreenPositionFunction(),mousexmax=windowWidth-document.getElementById("two").offsetWidth,mouseymin=document.getElementById("leiras").offsetHeight,zunit=.875*width/6,points=[.15*width,.15*height,3*zunit,.25*width,.15*height,3*zunit,.45*width,.15*height,3*zunit,.55*width,.15*height,3*zunit,.75*width,.15*height,3*zunit,.85*width,.15*height,3*zunit,.15*width,.5*height,2*zunit,.25*width,.5*height,2*zunit,.3*width,.5*height,2*zunit,.45*width,.5*height,2*zunit,.55*width,.5*height,2*zunit,.65*width,.5*height,2*zunit,.75*width,.5*height,2*zunit,.85*width,.5*height,2*zunit,.15*width,.6*height,1*zunit,.3*width,.6*height,1*zunit,.45*width,.6*height,1*zunit,.15*width,.1*height,0,.35*width,.1*height,0,.45*width,.1*height,0,.55*width,.1*height,0,.65*width,.1*height,0,.75*width,.1*height,0,.85*width,.1*height,0,.15*width,.6*height,-1*zunit,.35*width,.6*height,-1*zunit,.55*width,.8*height,-2*zunit,.75*width,.8*height,-2*zunit,.85*width,.8*height,-2*zunit,.15*width,.15*height,-3*zunit,.35*width,.15*height,-3*zunit,.55*width,.15*height,-3*zunit,.75*width,.15*height,-3*zunit,.85*width,.15*height,-3*zunit],sugar=height/2*2/tan(60*PI/360),szog1=PI/6,szog2=PI/4,dmx=0,dmy=0,shift_x=0,shift_y=0,shift_z=0,drawcn=!0,drawcp=!0,drawkp=!0,notPopup=!0,entered_pop=!1,on_point=-1,parchanged=!0,no_tmesh=!0,sfContainer=new Array(numpoints*(FELB+1)*(FELB+1));let e=FELB+1;for(let t=0;t<=FELB;++t)for(let s=0;s<=FELB;++s){let n=0;for(let o=0;o<knot_vecs.length;++o)for(let i=0;i<knot_vecs[o].length;i+=10)s_vec[s]>=knot_vecs[o][i]&&s_vec[s]<knot_vecs[o][i+4]&&t_vec[t]>=knot_vecs[o][i+5]&&t_vec[t]<knot_vecs[o][i+9]?sfContainer[t*e*numpoints+s*numpoints+n]=nurbs_weight(s_vec[s],3,knot_vecs[o].slice(i,i+5))*nurbs_weight(t_vec[t],3,knot_vecs[o].slice(i+5,i+10)):sfContainer[t*e*numpoints+s*numpoints+n]=0,++n}knotSContainer=new Array(s_points_dy.length),knotSst=new Array(s_points_dy.length),e=knotFelb+1;for(let t=0;t<s_points_dy.length;++t){knotSContainer[t]=new Array(s_points_dy[t].length-1),knotSst[t]=new Array(s_points_dy[t].length-1);for(let s=0;s<s_points_dy[t].length-1;++s)if(s_points_dy[t][s]){let n=abs_t[t+2];knotSst[t][s]=new Array(2*e);for(let o=1;o<2*e;o+=2)knotSst[t][s][o]=n;if(n>=t_min&&n<=t_max){knotSContainer[t][s]=new Array(e);let o=(abs_s[s_tmesh[t+2][s+3]]-abs_s[s_tmesh[t+2][s+2]])/knotFelb;for(let i=0;i<e;++i){knotSContainer[t][s][i]=new Array(numpoints);let e=abs_s[s_tmesh[t+2][s+2]]+i*o;if(knotSst[t][s][2*i]=e,e>=s_min&&e<=s_max){let o=0;for(let _=0;_<knot_vecs.length;++_)for(let r=0;r<knot_vecs[_].length;r+=10)e>=knot_vecs[_][r]&&e<knot_vecs[_][r+4]&&n>=knot_vecs[_][r+5]&&n<knot_vecs[_][r+9]?knotSContainer[t][s][i][o]=nurbs_weight(e,3,knot_vecs[_].slice(r,r+5))*nurbs_weight(n,3,knot_vecs[_].slice(r+5,r+10)):knotSContainer[t][s][i][o]=0,++o}}}}}knotTContainer=new Array(t_points_dy.length),knotTst=new Array(t_points_dy.length);for(let t=0;t<t_points_dy.length;++t){knotTContainer[t]=new Array(t_points_dy[t].length-1),knotTst[t]=new Array(t_points_dy[t].length-1);for(let s=0;s<t_points_dy[t].length-1;++s)if(t_points_dy[t][s]){let n=abs_s[t+2];knotTst[t][s]=new Array(2*e);for(let o=1;o<2*e;o+=2)knotTst[t][s][o]=n;if(n>=s_min&&n<=s_max){knotTContainer[t][s]=new Array(e);let o=(abs_t[t_tmesh[t+2][s+3]]-abs_t[t_tmesh[t+2][s+2]])/knotFelb;for(let i=0;i<e;++i){knotTContainer[t][s][i]=new Array(numpoints);let e=abs_t[t_tmesh[t+2][s+2]]+i*o;if(knotTst[t][s][2*i]=e,e>=t_min&&e<=t_max){let o=0;for(let _=0;_<knot_vecs.length;++_)for(let r=0;r<knot_vecs[_].length;r+=10)n>=knot_vecs[_][r]&&n<knot_vecs[_][r+4]&&e>=knot_vecs[_][r+5]&&e<knot_vecs[_][r+9]?knotTContainer[t][s][i][o]=nurbs_weight(n,3,knot_vecs[_].slice(r,r+5))*nurbs_weight(e,3,knot_vecs[_].slice(r+5,r+10)):knotTContainer[t][s][i][o]=0,++o}}}}}noLoop()}function draw(){if(background(111),cam.setPosition(-sugar*sin(szog2)*cos(szog1),-sugar*sin(szog1),sugar*cos(szog1)*cos(szog2)),cam.lookAt(0,0,0),cam.move(shift_x,shift_y,shift_z),translate(-width/2,-height/2),drawcn){stroke(180,180,180),strokeWeight(1),noFill();let t=0;for(let e=0;e<s_points_dy.length;++e){for(let s=0;s<s_points_dy[e].length-1;++s)s_points_dy[e][s]&&line(points[t],points[t+1],points[t+2],points[t+3],points[t+4],points[t+5]),t+=3;t+=3}for(let t=0;t<t_points_dy.length;++t)for(let e=0;e<t_points_dy[t].length-1;++e)if(t_points_dy[t][e]){let s=3*tcrawl[t][e],n=3*tcrawl[t][e+1];line(points[s],points[s+1],points[s+2],points[n],points[n+1],points[n+2])}}stroke(0),fill(0,255,0),drawdm?strokeWeight(1):noStroke(),ambientLight(130,130,130),pointLight(255,200,255,cam.eyeX,cam.eyeY+100,1e3),ambientMaterial(50,220,50);for(let t=0;t<=FELB;++t){let e=0,s=0,n=0,o=0;for(let i=0;i<numpoints;++i){let _=sfContainer[t*numpoints+i]*w_arr[i];o+=_,e+=_*points[3*i],s+=_*points[3*i+1],n+=_*points[3*i+2]}if(o>0){let i=1/o;puff_arr[3*t]=e*i,puff_arr[3*t+1]=s*i,puff_arr[3*t+2]=n*i}else 0}let t=FELB+1;for(let e=1;e<=FELB;++e){beginShape(TRIANGLE_STRIP);for(let s=0;s<=FELB;++s){vertex(puff_arr[3*s],puff_arr[3*s+1],puff_arr[3*s+2]);let n=0,o=0,i=0,_=0;for(let r=0;r<numpoints;++r){let h=sfContainer[e*t*numpoints+s*numpoints+r]*w_arr[r];_+=h,n+=h*points[3*r],o+=h*points[3*r+1],i+=h*points[3*r+2]}if(_>0){let t=1/_;vertex(n*t,o*t,i*t),puff_arr[3*s]=n*t,puff_arr[3*s+1]=o*t,puff_arr[3*s+2]=i*t}else 0}endShape()}if(drawkp){stroke(0),strokeWeight(3),noFill(),t=knotFelb+1;for(let e=0;e<s_points_dy.length;++e)for(let s=0;s<s_points_dy[e].length-1;++s)if(s_points_dy[e][s]){beginShape();for(let n=0;n<t;++n)if(knotSst[e][s][2*n]>=s_min&&knotSst[e][s][2*n]<=s_max&&knotSst[e][s][2*n+1]>=t_min&&knotSst[e][s][2*n+1]<=t_max){let t=0,o=0,i=0,_=0;for(let r=0;r<numpoints;++r){let h=knotSContainer[e][s][n][r]*w_arr[r];_+=h,t+=h*points[3*r],o+=h*points[3*r+1]-.05,i+=h*points[3*r+2]}if(_>0){let e=1/_;vertex(t*e,o*e,i*e)}}endShape()}for(let e=0;e<t_points_dy.length;++e)for(let s=0;s<t_points_dy[e].length-1;++s)if(t_points_dy[e][s]){beginShape();for(let n=0;n<t;++n)if(knotTst[e][s][2*n]>=t_min&&knotTst[e][s][2*n]<=t_max&&knotTst[e][s][2*n+1]>=s_min&&knotTst[e][s][2*n+1]<=s_max){let t=0,o=0,i=0,_=0;for(let r=0;r<numpoints;++r){let h=knotTContainer[e][s][n][r]*w_arr[r];_+=h,t+=h*points[3*r],o+=h*points[3*r+1]-.05,i+=h*points[3*r+2]}if(_>0){let e=1/_;vertex(t*e,o*e,i*e)}}endShape()}}if(drawcp){stroke(50,255,50),scp_arr=[];for(var e=0;e<points.length;e+=3)if(0!=pointsize_arr[e/3]){strokeWeight(20*pointsize_arr[e/3]),point(points[e],points[e+1],points[e+2]);let t=screenPosition(points[e],points[e+1],points[e+2]);scp_arr.push(t.x+width/2,t.y+height/2)}}}function distance(t,e,s,n){let o=t-s,i=e-n;return o*o+i*i}function mouseMoved(){if(no_tmesh&&mouseX<=mousexmax&&mouseY>mouseymin){let e=0;for(var t=0;t<points.length;t+=3,++e)if(distance(scp_arr[2*e],scp_arr[2*e+1],mouseX,mouseY)<=100){if(on_point!=t/3&&notPopup){on_point=t/3;let e=document.getElementById("myPopup");e.style.left=mouseX-e.offsetWidth/2+"px",e.style.top=mouseY+"px",e.classList.add("show"),notPopup=!1}break}}}function mousePressed(){if(mouseX<=mousexmax&&mouseY>mouseymin){let t=document.getElementById("myPopup");t.classList.contains("show")&&(t.classList.remove("show"),on_point=-1,notPopup=!0),mouseButton===CENTER?(shift_x=0,shift_y=0,shift_z=0,redraw()):(dmx=mouseX,dmy=mouseY)}}function mouseDragged(){if(mouseX<=mousexmax&&mouseY>mouseymin){if(mouseButton===LEFT){let t=mouseX-dmx,e=mouseY-dmy;t>0?(szog2+=t/width*PI,redraw()):t<0&&(szog2+=t/width*PI,redraw()),e>0?((szog1+=e/height*PI)>PI/2&&(szog1=PI/2),redraw()):e<0&&((szog1+=e/height*PI)<-PI/2&&(szog1=-PI/2),redraw())}else if(mouseButton===RIGHT){let t=mouseX-dmx,e=mouseY-dmy;t>0?(shift_x+=t,redraw()):t<0&&(shift_x+=t,redraw()),e>0?(shift_y+=e,redraw()):e<0&&(shift_y+=e,redraw())}dmx=mouseX,dmy=mouseY}}function mouseWheel(t){mouseX<=mousexmax&&mouseY>mouseymin&&(entered_pop||(t.delta>0?(sugar*=1.1,redraw()):(sugar*=.9,redraw())))}function keyPressed(){40===keyCode&&(shift_y+=10,redraw()),38===keyCode&&(shift_y-=10,redraw()),39===keyCode&&(shift_x+=10,redraw()),37===keyCode&&(shift_x-=10,redraw()),74===keyCode&&(shift_z+=10,redraw()),70===keyCode&&(shift_z-=10,redraw()),13===keyCode&&(shift_x=0,shift_y=0,shift_z=0,redraw())}init_tmesh();